# Mental-Base 統合テストガイド

## テスト構成

### テストフレームワーク
- **Vitest**: 高速なユニット・統合テストフレームワーク
- **@testing-library/react**: React コンポーネントテスト
- **@testing-library/jest-dom**: DOM マッチャー

### テストディレクトリ構造

```
tests/
├── setup.ts                    # テスト環境セットアップ
├── api/                        # API統合テスト
│   └── auth/                   # 認証API
│       ├── register.test.ts    # ユーザー登録テスト
│       └── password-reset.test.ts  # パスワードリセットテスト
└── README.md                   # このファイル
```

## テスト実行方法

### すべてのテストを実行

```bash
npm run test
```

### テストをwatch モードで実行

```bash
npm run test
```

### テストを1回だけ実行

```bash
npm run test:run
```

### テストUIを起動

```bash
npm run test:ui
```

## テスト実行前の準備

### 1. データベース接続確認

Supabaseデータベースが正常に接続できることを確認してください。

```bash
npx prisma studio
```

http://localhost:5555 でPrisma Studioが開けば接続成功です。

### 2. 開発サーバー起動

テストはNext.js開発サーバーに対して実行されます。

```bash
npm run dev
```

http://localhost:3247 でアプリが起動していることを確認してください。

### 3. テスト実行

別のターミナルウィンドウでテストを実行します。

```bash
npm run test:run
```

## Slice 1: 認証基盤 テストカバレッジ

### POST /api/auth/register

**テストファイル**: `tests/api/auth/register.test.ts`

#### 正常系テスト（2項目）
- ✅ 有効なデータで新規ユーザー登録が成功する
- ✅ パスワードがbcryptでハッシュ化される（ソルトラウンド10）

#### バリデーションテスト（4項目）
- ✅ 名前が2文字未満の場合、400エラーを返す
- ✅ メールアドレスが無効な形式の場合、400エラーを返す
- ✅ パスワードが8文字未満の場合、400エラーを返す
- ✅ 必須フィールドが欠けている場合、400エラーを返す

#### エラーハンドリングテスト（1項目）
- ✅ メールアドレスが既に登録されている場合、409エラーを返す

#### セキュリティテスト（1項目）
- ✅ XSS攻撃対策: スクリプトタグが含まれる名前を安全に処理する

**合計**: 8テストケース

---

### POST /api/auth/password-reset

**テストファイル**: `tests/api/auth/password-reset.test.ts`

#### 正常系テスト（2項目）
- ✅ 有効なメールアドレスでパスワードリセットリクエストが成功する
- ✅ セキュアなトークンが生成される（32バイトhex）

#### バリデーションテスト（2項目）
- ✅ メールアドレスが無効な形式の場合、400エラーを返す
- ✅ メールアドレスが空の場合、400エラーを返す

#### セキュリティテスト（2項目）
- ✅ 存在しないメールアドレスでも成功レスポンスを返す（情報漏洩防止）
- ✅ 既存のリセットトークンが削除され、新しいトークンが作成される

**合計**: 6テストケース

---

---

### POST /api/users/profile (GET/PUT)

**テストファイル**: `tests/api/users/profile.test.ts`

#### 正常系テスト（2項目）
- ✅ 認証済みユーザーのプロフィール情報を取得できる（GET）
- ✅ 有効なデータでプロフィール情報を更新できる（PUT）

#### バリデーションテスト（3項目）
- ✅ 名前が空の場合、400エラーを返す
- ✅ 無効なメールアドレス形式の場合、400エラーを返す
- ✅ 必須フィールドが欠けている場合、400エラーを返す

#### エラーハンドリングテスト（1項目）
- ✅ メールアドレスが既に使用されている場合、409エラーを返す

#### 認証テスト（2項目）
- ✅ 認証なしでGETアクセスすると401エラーを返す
- ✅ 認証なしでPUTアクセスすると401エラーを返す

**合計**: 10テストケース

---

### POST /api/users/password

**テストファイル**: `tests/api/users/password.test.ts`

#### 正常系テスト（2項目）
- ✅ 有効なデータでパスワードを変更できる
- ✅ パスワードがbcryptでハッシュ化される（ソルトラウンド10）

#### バリデーションテスト（3項目）
- ✅ 新しいパスワードが8文字未満の場合、400エラーを返す
- ✅ 新しいパスワードと確認用パスワードが一致しない場合、400エラーを返す
- ✅ 必須フィールドが欠けている場合、400エラーを返す

#### エラーハンドリングテスト（1項目）
- ✅ 現在のパスワードが間違っている場合、401エラーを返す

#### セキュリティテスト（2項目）
- ✅ 認証なしでアクセスすると401エラーを返す
- ✅ パスワード変更後、古いパスワードではログインできない

**合計**: 8テストケース

---

### GET/PUT /api/users/settings

**テストファイル**: `tests/api/users/settings.test.ts`

#### 正常系テスト（4項目）
- ✅ デフォルト設定が自動作成されて取得できる（GET）
- ✅ 既存の設定がある場合は設定を取得できる（GET）
- ✅ 有効なデータで通知設定を更新できる（PUT）
- ✅ 設定が存在しない場合は新規作成される（upsert）

#### バリデーションテスト（3項目）
- ✅ emailNotificationsが未定義の場合、400エラーを返す
- ✅ reminderTimeが無効な形式の場合、400エラーを返す
- ✅ reminderTimeがHH:mm形式でない場合、400エラーを返す

#### エッジケーステスト（2項目）
- ✅ 有効な時刻範囲の境界値（00:00）を受け入れる
- ✅ 有効な時刻範囲の境界値（23:59）を受け入れる

#### 認証テスト（2項目）
- ✅ 認証なしでGETアクセスすると401エラーを返す
- ✅ 認証なしでPUTアクセスすると401エラーを返す

**合計**: 12テストケース

---

### DELETE /api/users/account

**テストファイル**: `tests/api/users/account.test.ts`

#### 正常系テスト（2項目）
- ✅ アカウントとすべての関連データを削除できる
- ✅ 確認テキストありでアカウントを削除できる

#### カスケード削除テスト（4項目）
- ✅ Goal, Task, Logが正しくカスケード削除される
- ✅ Reflection, AIAnalysisReport, ActionPlanが正しくカスケード削除される
- ✅ ChatMessage, Notificationが正しくカスケード削除される
- ✅ Session, PasswordResetTokenが正しくカスケード削除される

#### セキュリティテスト（2項目）
- ✅ 他人のアカウント削除を試行すると403エラーを返す
- ✅ 認証なしでアクセスすると401エラーを返す

#### トランザクションテスト（1項目）
- ✅ 削除処理がトランザクションで実行される

**合計**: 9テストケース

---

## テスト総数

**Slice 1 認証基盤**: 14テストケース
**Slice 2-A ユーザー管理**: 39テストケース
**合計**: 53テストケース

## テストのベストプラクティス

### 1. テストの独立性

各テストは独立して実行できるようにします。`beforeEach`でテストデータをクリーンアップします。

```typescript
beforeEach(async () => {
  await prisma.user.deleteMany({
    where: { email: testEmail },
  });
});
```

### 2. データベースのクリーンアップ

テスト終了後、作成したデータを削除します。

```typescript
afterAll(async () => {
  await prisma.$disconnect();
});
```

### 3. 明確なテスト名

テスト名は「何をテストするか」が明確にわかるようにします。

```typescript
it('有効なデータで新規ユーザー登録が成功する', async () => {
  // テストコード
});
```

### 4. AAA パターン

- **Arrange**: テストデータを準備
- **Act**: テスト対象の関数を実行
- **Assert**: 結果を検証

## トラブルシューティング

### データベース接続エラー

```
Error: P1001: Can't reach database server
```

**解決方法**:
1. `.env.local`の`DATABASE_URL`と`DIRECT_DATABASE_URL`を確認
2. Supabaseプロジェクトが起動しているか確認
3. ネットワーク接続を確認

### ポート競合エラー

```
Error: Port 3247 is already in use
```

**解決方法**:
1. 既存の開発サーバーを停止
2. または、別のポートを使用

```bash
pkill -f "next dev"
npm run dev
```

### Prisma Client エラー

```
Error: @prisma/client did not initialize yet
```

**解決方法**:

```bash
npx prisma generate
```

## 次のステップ

### Slice 2-B: 目標・タスク管理テスト作成

Slice 2-Aのテストが完了したら、次のテストを作成します：

- **Slice 2-B**: 目標・タスク管理テスト（10エンドポイント）
  - GET /api/plan-do（ページ統合データ）
  - GET /api/goals（進捗率計算）
  - POST /api/goals
  - PUT /api/goals/{id}
  - DELETE /api/goals/{id}（カスケード削除）
  - GET /api/tasks/today（Goal名結合）
  - POST /api/tasks
  - PATCH /api/tasks/{id}/toggle
  - DELETE /api/tasks/{id}
  - POST /api/logs

---

**作成日**: 2025-11-02
**最終更新**: 2025-11-02
