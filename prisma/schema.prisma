generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                            String                       @id @default(uuid())
  email                         String                       @unique
  name                          String
  password                      String
  emailVerified                 DateTime?
  createdAt                     DateTime                     @default(now())
  updatedAt                     DateTime                     @updatedAt
  role                          String                       @default("client")
  isMentor                      Boolean                      @default(false)
  bio                           String?
  expertise                     String[]                     @default([])
  actionPlans                   ActionPlan[]
  aiAnalysisReports             AIAnalysisReport[]
  chatMessages                  ChatMessage[]
  accessPermissionsGiven        ClientDataAccessPermission[] @relation("ClientPermissions")
  clientViewLogs                ClientDataViewLog[]          @relation("MentorViews")
  clientProgressReportsAsClient ClientProgressReport[]       @relation("ClientReports")
  clientProgressReportsAsMentor ClientProgressReport[]       @relation("MentorReports")
  goals                         Goal[]
  logs                          Log[]
  mentorRelationshipsAsClient   MentorClientRelationship[]   @relation("ClientRelations")
  mentorRelationshipsAsMentor   MentorClientRelationship[]   @relation("MentorRelations")
  mentorNotes                   MentorNote[]                 @relation("MentorCreatedNotes")
  notifications                 Notification[]
  passwordResetTokens           PasswordResetToken[]
  reflections                   Reflection[]
  sessions                      Session[]
  tasks                         Task[]
  userSettings                  UserSettings?

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model UserSettings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  emailNotifications Boolean  @default(true)
  reminderTime       String?
  theme              String   @default("professional")
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Goal {
  id          String    @id @default(uuid())
  userId      String
  title       String    @db.VarChar(200)
  description String?
  deadline    DateTime?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([userId])
  @@index([status])
  @@map("goals")
}

model Task {
  id            String    @id @default(uuid())
  userId        String
  goalId        String?
  title         String    @db.VarChar(200)
  description   String?
  dueDate       DateTime?
  scheduledTime String?
  priority      String    @default("medium")
  status        String    @default("pending")
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  logs          Log[]
  goal          Goal?     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([goalId])
  @@index([dueDate])
  @@index([status])
  @@map("tasks")
}

model Log {
  id        String   @id @default(uuid())
  userId    String
  taskId    String?
  content   String
  emotion   String?
  state     String?
  type      String   @default("daily")
  createdAt DateTime @default(now())
  task      Task?    @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskId])
  @@index([createdAt])
  @@map("logs")
}

model Reflection {
  id               String             @id @default(uuid())
  userId           String
  period           String
  startDate        DateTime
  endDate          DateTime
  content          String
  achievements     String?
  challenges       String?
  createdAt        DateTime           @default(now())
  aiAnalysisReport AIAnalysisReport[]
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("reflections")
}

model AIAnalysisReport {
  id              String       @id @default(uuid())
  userId          String
  reflectionId    String?
  analysisType    String
  insights        Json
  recommendations Json
  summary         String?
  confidence      Float
  createdAt       DateTime     @default(now())
  actionPlans     ActionPlan[]
  reflection      Reflection?  @relation(fields: [reflectionId], references: [id])
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reflectionId])
  @@index([createdAt])
  @@map("ai_analysis_reports")
}

model ActionPlan {
  id          String            @id @default(uuid())
  userId      String
  reportId    String?
  title       String            @db.VarChar(200)
  description String
  actionItems Json
  status      String            @default("planned")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  report      AIAnalysisReport? @relation(fields: [reportId], references: [id])
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@index([status])
  @@map("action_plans")
}

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  role      String
  content   String
  mode      String
  context   Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mode])
  @@index([createdAt])
  @@map("chat_messages")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String   @db.VarChar(200)
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model MentorClientRelationship {
  id                String                      @id @default(uuid())
  mentorId          String
  clientId          String
  status            String                      @default("pending")
  invitedBy         String
  invitedAt         DateTime                    @default(now())
  acceptedAt        DateTime?
  terminatedAt      DateTime?
  terminationReason String?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  accessPermissions ClientDataAccessPermission?
  client            User                        @relation("ClientRelations", fields: [clientId], references: [id], onDelete: Cascade)
  mentor            User                        @relation("MentorRelations", fields: [mentorId], references: [id], onDelete: Cascade)

  @@unique([mentorId, clientId])
  @@index([mentorId])
  @@index([clientId])
  @@index([status])
  @@map("mentor_client_relationships")
}

model ClientDataAccessPermission {
  id               String                   @id @default(uuid())
  relationshipId   String                   @unique
  clientId         String
  allowGoals       Boolean                  @default(true)
  allowTasks       Boolean                  @default(true)
  allowLogs        Boolean                  @default(true)
  allowReflections Boolean                  @default(true)
  allowAiReports   Boolean                  @default(true)
  isActive         Boolean                  @default(true)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  client           User                     @relation("ClientPermissions", fields: [clientId], references: [id], onDelete: Cascade)
  relationship     MentorClientRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([isActive])
  @@map("client_data_access_permissions")
}

model ClientDataViewLog {
  id        String   @id @default(uuid())
  mentorId  String
  clientId  String
  dataType  String
  dataId    String
  action    String
  createdAt DateTime @default(now())
  mentor    User     @relation("MentorViews", fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([mentorId])
  @@index([clientId])
  @@index([dataType])
  @@index([createdAt])
  @@map("client_data_view_logs")
}

model MentorNote {
  id                 String   @id @default(uuid())
  mentorId           String
  clientId           String
  title              String   @db.VarChar(200)
  content            String
  noteType           String   @default("general")
  tags               String[] @default([])
  linkedDataType     String?
  linkedDataId       String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isSharedWithClient Boolean  @default(false)
  mentor             User     @relation("MentorCreatedNotes", fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([mentorId])
  @@index([clientId])
  @@index([noteType])
  @@index([createdAt])
  @@map("mentor_notes")
}

model ClientProgressReport {
  id                 String    @id @default(uuid())
  clientId           String
  mentorId           String
  reportPeriod       String
  startDate          DateTime
  endDate            DateTime
  overallProgress    Float
  completedGoals     Int       @default(0)
  completedTasks     Int       @default(0)
  logCount           Int       @default(0)
  reflectionCount    Int       @default(0)
  mentorComments     String?
  mentorRating       Int?
  areasOfImprovement String[]  @default([])
  strengths          String[]  @default([])
  nextSteps          String?
  followUpDate       DateTime?
  isSharedWithClient Boolean   @default(false)
  sharedAt           DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  client             User      @relation("ClientReports", fields: [clientId], references: [id], onDelete: Cascade)
  mentor             User      @relation("MentorReports", fields: [mentorId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([mentorId])
  @@index([reportPeriod])
  @@index([createdAt])
  @@map("client_progress_reports")
}
