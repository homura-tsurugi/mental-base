# ライフ・ワークガバナンス プラットフォーム（フェーズ2: メンター機能） - 要件定義書

**バージョン**: 2.0.0 (Phase 2 - Mentor Features)
**最終更新日**: 2025-11-02
**ステータス**: 確定

---

## 要件定義の作成原則

- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標（フェーズ2）

**フェーズ2で実現する最終成果**

メンターがAI支援を活用して複数クライアントの課題を早期発見し、1つのダッシュボードで全体を把握しながら効率的かつ体系的に成長支援できる管理システム。

**実装範囲の確定**
- ✅ ユーザー種別: クライアント（既存）+ メンター（新規）
- ✅ ロール管理: CLIENT / MENTOR の2ロール
- ✅ メンター-クライアント関係: 1対多（1メンター：複数クライアント）
- ✅ データアクセス制御: きめ細かい権限管理
- ✅ メンターダッシュボード: 全クライアント統合表示
- ✅ クライアント詳細閲覧: 進捗・データ確認
- ✅ メンターノート: クライアント別メモ機能
- ✅ 進捗レポート生成: 定期報告書作成
- ❌ メッセージング機能: フェーズ3以降に実装
- ❌ AI自動アラート: フェーズ3以降に実装
- ❌ 組織管理機能: フェーズ3以降に実装

### 1.2 成功指標

#### 定量的指標
1. **1人のメンターが10人以上のクライアントを同時にサポートできる**（効率性）
2. **全クライアントの状況確認が5分以内で完了する**（可視化速度）
3. **メンターの管理業務時間が週3時間以内で完結する**（負担軽減）
4. **クライアント個別詳細への遷移が2クリック以内**（操作性）
5. **クライアントの停滞・課題を1週間以内に発見できる**（早期発見）

#### 定性的指標
1. **メンターが「クライアント全体の状況を一目で把握できる」と感じる**（可視化）
2. **メンターが「誰に介入すべきか優先順位が判断しやすい」と感じる**（意思決定支援）
3. **クライアントが「適切なタイミングでサポートを受けられた」と感じる**（介入品質）
4. **メンターが「個別クライアントの詳細データにすぐアクセスできる」と感じる**（情報アクセス）
5. **メンターが「この仕組みなら長期的に続けられる」と感じる**（持続性）

### 1.3 要件確定事項（決定済み）

**最終決定日**: 2025-11-02

フェーズ2実装前の要件検証により、以下の項目について最終決定しました。

#### 決定事項一覧

| 項目 | 決定内容 | 理由・背景 | 影響範囲 |
|------|---------|-----------|----------|
| **1. 招待フロー** | **メンター主導** | メンターが自らクライアントを選び、メールアドレスで招待する方式を採用。クライアント主導（メンター検索・選択）は実装複雑度が高く、MVP段階では不要。 | - MentorClientRelationship.invitedBy: 常にmentorIdを設定<br>- 招待API: `/api/mentor/invite`でメンターがクライアントのメールアドレスを入力<br>- クライアント側は招待を承認/拒否するのみ |
| **2. データアクセス許可デフォルト** | **全て許可（緩和策あり）** | 関係成立時に全データタイプ（Goals, Tasks, Logs, Reflections, AI Reports）への許可を自動付与。<br><br>**理由**: まずは身近なクライアントで試用するため、全て公開される旨を伝えれば問題ない。<br><br>**緩和策**: 1) 関係成立時に通知を送信、2) 設定ページへの誘導 | - ClientDataAccessPermission: デフォルト値を`true`に変更<br>- 関係成立時に全て許可で初期化<br>- 通知機能で「メンターがあなたのデータにアクセス可能になりました」を送信<br>- 設定ページ（C-005）でいつでも変更可能 |
| **3. 複数メンター保持** | **可能** | 1人のクライアントが複数のメンターを同時に持てる仕様。異なる専門分野のメンターから支援を受けるニーズに対応。 | - MentorClientRelationship: mentorId + clientIdの組み合わせで複数レコード可能<br>- `@@unique([mentorId, clientId])`で重複防止<br>- クライアント側設定で各メンターへのアクセス許可を個別管理 |
| **4. MentorNoteフィールド名統一** | **isSharedWithClientに統一** | Prismaスキーマでは`isPrivate`、型定義では`isSharedWithClient`と不一致だったため、`isSharedWithClient`に統一。true=クライアントと共有、false=メンター専用。 | - Prismaスキーマ修正: `MentorNote.isPrivate` → `MentorNote.isSharedWithClient`<br>- デフォルト値: `false`（メンター専用）<br>- マイグレーション必要 |
| **5. User型の統一** | **User型を拡張、UserExtended削除** | `types/index.ts`でUserとUserExtendedが分離していたため、User型を拡張してフェーズ2フィールド（role, isMentor, bio, expertise）を追加し、UserExtendedは削除。 | - `types/index.ts`: User型にrole/isMentor/bio/expertise追加<br>- UserExtended型を削除<br>- 全15ファイルでUser型利用箇所を確認・修正 |

#### 決定の根拠

**1. 招待フロー: メンター主導**
- クライアント主導の場合、メンター検索機能、プロフィール公開、評価システムなどが必要になり、MVP範囲を超える
- メンター主導なら、メンターが既知のクライアントに直接招待を送るシンプルなフローで実現可能
- フェーズ3以降でメンター検索機能を追加することも可能

**2. データアクセス許可デフォルト: 全て許可**
- ユーザーの判断: 「まずは身近なクライアントで試用するから全て公開される旨伝えるし特に漏れて問題のある情報もないから大丈夫」
- 緩和策として通知と設定誘導を実装することで、データ公開について適切に周知
- クライアントはいつでも設定ページで許可を変更可能

**3. 複数メンター保持: 可能**
- 実世界のニーズに対応（例: キャリアメンター + メンタルヘルスメンター）
- データベース設計で対応可能（@@unique制約で重複防止）
- アクセス許可は各メンターごとに個別管理

**4. MentorNoteフィールド名統一: isSharedWithClient**
- `isPrivate`は否定形で理解しづらい（true=非公開、false=公開）
- `isSharedWithClient`は肯定形で直感的（true=共有、false=非共有）
- コードの可読性と保守性を向上

**5. User型の統一**
- 型の重複はバグの温床となる
- User型を単一の真実の源（Single Source of Truth）とする
- フェーズ1とフェーズ2の統合をスムーズにする

#### 実装への影響

これらの決定により、以下の実装が必要となります:

1. **Prismaスキーマ修正**
   - `MentorNote.isPrivate` → `MentorNote.isSharedWithClient`
   - `ClientDataAccessPermission`の各フィールドのデフォルトを`true`に変更
   - マイグレーション実行

2. **型定義修正**
   - `types/index.ts`でUser型を拡張
   - UserExtended型を削除

3. **招待API実装**
   - `POST /api/mentor/invite`: メンターがクライアントのメールアドレスで招待
   - `POST /api/mentor/relationships/{id}/accept`: クライアントが招待を承認

4. **通知機能実装**
   - 関係成立時に「メンターがあなたのデータにアクセス可能になりました」通知を送信
   - 設定ページへの誘導リンクを含める

5. **設定ページ拡張（C-005）**
   - データアクセス許可設定セクションの実装
   - 各データタイプごとの許可トグル

---

## 2. システム全体像

### 2.1 主要機能一覧

#### クライアント機能（フェーズ1継続）
- **COM:PASSサイクル管理**: 目標設定、タスク実行、振り返り、改善
- **AI連携機能**: アドバイス生成、ログ分析、フィードバック
- **認証・アカウント管理**: ログイン、プロフィール管理

#### メンター機能（フェーズ2新規）
- **メンターダッシュボード**: 担当クライアント一覧、統計サマリー、検索・フィルター
- **クライアント詳細管理**: 個別クライアントの進捗確認、データ閲覧
- **メンターノート**: クライアント別のメモ・観察記録
- **進捗レポート生成**: 週次・月次の進捗レポート作成
- **データアクセス制御**: クライアントの許可に基づくデータ閲覧

### 2.2 ユーザーロールと権限

#### ゲスト（未ログイン）
**アクセス可能な機能:**
- 認証ページ（ログイン・登録）のみ

#### クライアント（CLIENT）
**アクセス可能な機能:**
- COM:PASS全機能（目標設定、タスク管理、ログ記録、振り返り、改善）
- AIアシスタントとの対話
- 自分のデータの閲覧・編集
- プロフィール・設定管理
- メンターへのデータアクセス許可設定

**アクセス制限:**
- 他のユーザーのデータは閲覧・編集不可
- メンター専用機能へのアクセス不可

#### メンター（MENTOR）
**アクセス可能な機能:**
- 自分自身のCOM:PASS機能（メンターも成長可能）
- メンターダッシュボード（担当クライアント管理）
- クライアント詳細閲覧（許可されたデータのみ）
- メンターノート作成・編集
- クライアント進捗レポート生成
- クライアントへの招待（簡易実装）

**アクセス制限:**
- クライアントが許可していないデータは閲覧不可
- 他のメンターのノート・レポートは閲覧不可
- システム管理機能なし

**重要**: 1人のユーザーが CLIENT と MENTOR の両方のロールを持つことが可能

### 2.3 認証・認可要件

**認証方式:**
- メール＋パスワード
- Auth.js (NextAuth v5)による実装
- パスワードリセット機能あり

**ロール管理:**
- ユーザー登録時はデフォルトで CLIENT ロール
- 設定ページで「メンターとして登録」機能を提供
- ロール情報はセッション（JWT）に含める
- Data Access Layer (DAL)パターンでロール検証

**セキュリティ要件:**
- パスワードのbcryptハッシュ化（ソルトラウンド: 10）
- CSRF保護（Auth.js標準実装）
- JWT暗号化（JWE, A256GCM）
- HttpOnly Cookie（XSS攻撃防止）
- Secure Cookie（HTTPS必須、本番環境）
- パスワードポリシー: 8文字以上、英数字混在推奨

**データアクセス制御:**
- クライアントデータは本人のみアクセス可能（デフォルト）
- メンターは明示的な許可がある場合のみクライアントデータを閲覧
- データタイプごとに許可を細かく制御可能（Goal/Task/Log/Reflection/AI Report）
- すべてのメンターアクセスは監査ログに記録（ClientDataViewLog）

**セッション管理:**
- JWT戦略（サーバーレス対応）
- セッション有効期限: 30日間（更新可能）

**管理機能:**
- フェーズ2では不要（メンター-クライアント関係に集中）

---

## 3. ページ詳細仕様

### 3.1 ページ一覧

フェーズ2では**既存6ページ + 新規2ページ + 既存1ページ拡張**を実装：

#### 公開ページ（1ページ）

| ID | ページ名 | ルート | 権限レベル | 優先度 | 変更 |
|----|---------|-------|----------|-------|------|
| P-001 | 認証ページ | `/auth` | 公開 | 高 | なし |

#### クライアントページ（5ページ）

| ID | ページ名 | ルート | 権限レベル | 優先度 | 変更 |
|----|---------|-------|----------|-------|------|
| C-001 | ホーム（ダッシュボード） | `/` | CLIENT/MENTOR | 高 | なし |
| C-002 | 目標・実行ページ | `/plan-do` | CLIENT/MENTOR | 高 | なし |
| C-003 | 振り返り・改善ページ | `/check-action` | CLIENT/MENTOR | 高 | なし |
| C-004 | AIアシスタント | `/ai-assistant` | CLIENT/MENTOR | 高 | なし |
| C-005 | 設定 | `/settings` | CLIENT/MENTOR | 中 | **拡張** |

#### メンターページ（2ページ）- 新規

| ID | ページ名 | ルート | 権限レベル | 優先度 |
|----|---------|-------|----------|-------|
| M-001 | メンターダッシュボード | `/mentor` | MENTOR | 高 |
| M-002 | クライアント詳細 | `/mentor/client/[id]` | MENTOR | 高 |

---

### 3.2 M-001: メンターダッシュボード

#### 目的
担当クライアント全体の進捗と優先対応者を一目で把握

#### 主要機能
- 統計サマリー表示（担当クライアント数、アクティブ数、要フォロー数、平均進捗率）
- クライアント一覧（カード表示）
- 検索・フィルター機能
- ソート機能（進捗率/最終活動日/名前）
- クライアント詳細への遷移

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 担当クライアント一覧取得 | mentorId（セッション） | クライアント一覧、統計サマリー |
| 取得 | クライアント検索 | 検索キーワード | フィルタリングされたクライアント一覧 |
| 取得 | クライアントフィルター | ステータス（全て/順調/停滞/要フォロー） | フィルタリングされたクライアント一覧 |

#### 処理フロー
1. ページロード時、メンターIDでクライアント一覧を取得
2. 各クライアントの進捗率、最終活動日、ステータスを計算
3. 統計サマリーを集計表示
4. クライアントカードをグリッド表示
5. ユーザーが検索・フィルター・ソートを実行
6. クライアントカードをクリック → 詳細ページへ遷移

#### データ構造（概念）

```yaml
MentorDashboardData:
  statistics:
    - totalClients（担当クライアント総数）
    - activeClients（今週アクティブなクライアント数）
    - needsFollowUp（要フォロークライアント数）
    - averageProgress（平均進捗率、パーセント）
  clients:
    - ClientSummary[]（クライアント一覧）

ClientSummary:
  識別子: clientId (UUID)
  基本情報:
    - name（名前）
    - email（メールアドレス）
    - avatarUrl（アバター画像URL、任意）
  進捗情報:
    - overallProgress（総合進捗率、0-100）
    - lastActivityDate（最終活動日時）
    - status（ステータス: on_track, stagnant, needs_followup）
  関連:
    - relationshipId（MentorClientRelationshipのID）
```

---

### 3.3 M-002: クライアント詳細

#### 目的
個別クライアントの詳細情報と進捗を確認し適切に介入

#### 主要機能
- クライアント基本情報表示
- COM:PASS進捗詳細（タブ表示）
  - タブ1: 目標一覧（Goals）
  - タブ2: タスク一覧（Tasks）
  - タブ3: ログ履歴（Logs）
  - タブ4: 振り返り（Reflections）
  - タブ5: AI分析レポート
  - タブ6: メンターノート
- メンターノート作成・編集
- 進捗レポート生成
- アクセス権限確認

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | クライアント詳細取得 | clientId | クライアント情報、進捗データ |
| 取得 | クライアントのGoal取得 | clientId | Goal[]（許可されている場合のみ） |
| 取得 | クライアントのTask取得 | clientId | Task[]（許可されている場合のみ） |
| 取得 | クライアントのLog取得 | clientId | Log[]（許可されている場合のみ） |
| 取得 | クライアントのReflection取得 | clientId | Reflection[]（許可されている場合のみ） |
| 取得 | クライアントのAI Report取得 | clientId | AIAnalysisReport[]（許可されている場合のみ） |
| 取得 | メンターノート一覧取得 | mentorId、clientId | MentorNote[] |
| 作成 | メンターノート作成 | タイトル、内容、タイプ、タグ、公開設定 | 作成されたMentorNote |
| 更新 | メンターノート編集 | noteId、更新内容 | 更新されたMentorNote |
| 削除 | メンターノート削除 | noteId | 削除確認 |
| 作成 | 進捗レポート生成 | clientId、期間、コメント | 作成されたClientProgressReport |

#### 処理フロー

**データ閲覧:**
1. ページロード時、クライアントIDでデータ取得リクエスト
2. メンター-クライアント関係を確認
3. データアクセス権限を確認
4. 許可されているデータのみ取得・表示
5. 許可されていないデータは「アクセス権限がありません」と表示
6. データ閲覧ログを記録（ClientDataViewLog）

**メンターノート作成:**
1. ユーザーが「新規ノート作成」ボタンをクリック
2. タイトル、内容、ノートタイプ、タグを入力
3. 公開/非公開を選択
4. 特定のGoal/Task/Logにリンク（任意）
5. DBに保存
6. ノート一覧を更新

**進捗レポート生成:**
1. ユーザーが「レポート生成」ボタンをクリック
2. 期間（週次/月次）を選択
3. クライアントの進捗データを自動集計
4. メンターがコメント・評価を入力
5. プレビュー表示
6. 「保存」または「保存して共有」を選択
7. DBに保存、必要に応じてクライアントに共有

#### データ構造（概念）

```yaml
ClientDetailData:
  clientInfo:
    - id（クライアントID）
    - name（名前）
    - email（メールアドレス）
    - registeredAt（登録日）
    - relationshipStartDate（メンター関係開始日）
  permissions:
    - allowGoals（目標閲覧許可、boolean）
    - allowTasks（タスク閲覧許可、boolean）
    - allowLogs（ログ閲覧許可、boolean）
    - allowReflections（振り返り閲覧許可、boolean）
    - allowAiReports（AI分析レポート閲覧許可、boolean）
  progressData:
    - overallProgress（総合進捗率）
    - goals（Goal[]、許可されている場合のみ）
    - tasks（Task[]、許可されている場合のみ）
    - logs（Log[]、許可されている場合のみ）
    - reflections（Reflection[]、許可されている場合のみ）
    - aiReports（AIAnalysisReport[]、許可されている場合のみ）
  mentorNotes:
    - MentorNote[]（メンターノート一覧）

MentorNote:
  識別子: id (UUID)
  基本情報:
    - mentorId（メンターのユーザーID、必須）
    - clientId（クライアントのユーザーID、必須）
    - title（タイトル、必須）
    - content（内容、必須）
    - noteType（ノートタイプ: general, observation, concern, achievement）
    - isPrivate（公開/非公開、boolean）
    - tags（タグ、文字列配列）
    - linkedDataType（リンクするデータタイプ、任意）
    - linkedDataId（リンクするデータのID、任意）
  メタ情報:
    - createdAt（作成日時）
    - updatedAt（更新日時）

ClientProgressReport:
  識別子: id (UUID)
  基本情報:
    - clientId（クライアントのユーザーID、必須）
    - mentorId（メンターのユーザーID、必須）
    - reportPeriod（期間タイプ: weekly, monthly）
    - startDate（期間開始日）
    - endDate（期間終了日）
  進捗サマリー:
    - overallProgress（総合進捗率、0-100）
    - completedGoals（完了した目標数）
    - completedTasks（完了したタスク数）
    - logCount（ログ記録数）
    - reflectionCount（振り返り記録数）
  メンター評価:
    - mentorComments（メンターコメント、任意）
    - mentorRating（評価、1-5段階、任意）
    - areasOfImprovement（改善が必要な領域、文字列配列）
    - strengths（強みとして認識された領域、文字列配列）
    - nextSteps（次のアクション、任意）
    - followUpDate（フォローアップ予定日、任意）
  公開設定:
    - isSharedWithClient（クライアントと共有、boolean）
    - sharedAt（共有日時、任意）
  メタ情報:
    - createdAt（作成日時）
    - updatedAt（更新日時）
```

---

### 3.4 C-005: 設定（拡張版）

#### 目的
プロフィール管理、通知設定、メンター登録

#### 追加機能（フェーズ2）

**メンター登録セクション:**
- 「メンターとして登録する」トグルスイッチ
- 自己紹介（bio）入力フィールド（500文字以内）
- 専門分野（expertise）選択（複数選択可）
  - 選択肢: キャリア、メンタルヘルス、学習、ライフコーチング、健康・ウェルネス、起業・ビジネス、その他
- 保存ボタン

**データアクセス許可設定セクション（クライアント向け）:**
- 担当メンターがいる場合のみ表示
- メンターに公開するデータを選択
  - ☑ 目標（Goals）
  - ☑ タスク（Tasks）
  - ☑ ログ（Logs）
  - ☑ 振り返り（Reflections）
  - ☑ AI分析レポート
- 保存ボタン
- 注意書き: 「メンターがあなたのデータを閲覧すると、閲覧ログが記録されます」

#### 既存機能（変更なし）
- プロフィール編集（名前、メール）
- パスワード変更
- 通知設定（メール通知のオン/オフ）
- アカウント削除

#### 必要な操作（追加分のみ）

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 更新 | メンター登録 | isMentor、bio、expertise | 更新されたUser |
| 取得 | データアクセス許可取得 | userId | ClientDataAccessPermission |
| 更新 | データアクセス許可更新 | 許可設定（各データタイプのboolean） | 更新されたClientDataAccessPermission |

---

## 4. データモデル概要

### 4.1 主要エンティティ

#### 既存エンティティ（フェーズ1）

| エンティティ | 主な属性 | 関連エンティティ | 備考 |
|------------|----------|----------------|------|
| User | id, email, password, name, **role**, **isMentor**, **bio**, **expertise** | Session, Goal, Task, Log, Reflection, ChatMessage, **MentorClientRelationship** | 認証基本情報、**フェーズ2で拡張** |
| Session | id, sessionToken, userId, expires | User | セッション管理 |
| Goal | id, userId, title, description, deadline, status | User, Task | 目標管理 |
| Task | id, userId, goalId, title, dueDate, priority, status | User, Goal, Log | タスク管理 |
| Log | id, userId, taskId, content, emotion, state, type | User, Task | 日々の活動記録 |
| Reflection | id, userId, period, startDate, endDate, content | User, AIAnalysisReport | 振り返り記録 |
| AIAnalysisReport | id, userId, reflectionId, insights, recommendations | User, Reflection | AI分析結果 |
| ActionPlan | id, userId, reportId, title, actionItems, status | User, AIAnalysisReport | 改善計画 |
| ChatMessage | id, userId, role, content, mode | User | AIチャット履歴 |
| UserSettings | userId, emailNotifications, reminderTime, theme | User | ユーザー設定 |
| PasswordResetToken | id, userId, token, expires | User | パスワードリセット |

#### 新規エンティティ（フェーズ2）

| エンティティ | 主な属性 | 関連エンティティ | 備考 |
|------------|----------|----------------|------|
| MentorClientRelationship | id, mentorId, clientId, status, invitedBy, acceptedAt | User（Mentor）, User（Client）, ClientDataAccessPermission | メンター-クライアント関係 |
| ClientDataAccessPermission | id, relationshipId, clientId, allowGoals, allowTasks, allowLogs, allowReflections, allowAiReports | MentorClientRelationship, User（Client） | データアクセス権限 |
| ClientDataViewLog | id, mentorId, clientId, dataType, dataId, action, createdAt | User（Mentor） | データ閲覧監査ログ |
| MentorNote | id, mentorId, clientId, title, content, noteType, isPrivate, tags | User（Mentor） | メンターノート |
| ClientProgressReport | id, clientId, mentorId, reportPeriod, startDate, endDate, overallProgress, mentorComments | User（Client）, User（Mentor） | 進捗レポート |

### 4.2 エンティティ関係図

```
User ──┬── Session (1対多)
       ├── Goal (1対多)
       │    └── Task (1対多)
       ├── Task (1対多)
       │    └── Log (1対多)
       ├── Log (1対多)
       ├── Reflection (1対多)
       │    └── AIAnalysisReport (1対多)
       ├── AIAnalysisReport (1対多)
       │    └── ActionPlan (1対多)
       ├── ActionPlan (1対多)
       ├── ChatMessage (1対多)
       ├── UserSettings (1対1)
       ├── PasswordResetToken (1対多)
       │
       ├── MentorClientRelationship (as Mentor) (1対多)
       │    └── ClientDataAccessPermission (1対多)
       ├── MentorClientRelationship (as Client) (1対多)
       ├── ClientDataViewLog (as Mentor) (1対多)
       ├── MentorNote (1対多)
       ├── ClientProgressReport (as Client) (1対多)
       └── ClientProgressReport (as Mentor) (1対多)
```

### 4.3 バリデーションルール

```yaml
# 既存ルール（フェーズ1）
メールアドレス:
  - ルール: 有効なメール形式、ユニーク
  - 理由: アカウント識別と通知送信のため

パスワード:
  - ルール: 8文字以上、英数字混在推奨
  - 理由: セキュリティ確保のため

目標タイトル:
  - ルール: 1文字以上、200文字以下
  - 理由: 可読性とDB制約

タスクタイトル:
  - ルール: 1文字以上、200文字以下
  - 理由: 可読性とDB制約

ログ内容:
  - ルール: 1文字以上、5000文字以下
  - 理由: AI分析の効率性とDB制約

チャットメッセージ:
  - ルール: 1文字以上、2000文字以下
  - 理由: AI APIのトークン制限

# 新規ルール（フェーズ2）
メンター自己紹介（bio）:
  - ルール: 500文字以下
  - 理由: 可読性とDB制約

メンター専門分野（expertise）:
  - ルール: 1つ以上選択、最大10個
  - 理由: メンター検索の効率性

メンターノートタイトル:
  - ルール: 1文字以上、200文字以下
  - 理由: 可読性とDB制約

メンターノート内容:
  - ルール: 1文字以上、5000文字以下
  - 理由: 可読性とDB制約

進捗レポートコメント:
  - ルール: 5000文字以下
  - 理由: 可読性とDB制約
```

---

## 5. 制約事項

### 5.1 外部API制限（既存と同じ）

#### Anthropic Claude API（開発環境）
- **無料枠**: $10まで（約1.4ヶ月、10ユーザー想定）
- **Rate Limit**: 5リクエスト/分（Free Tier）
- **トークン制限**: 20,000トークン/分、300,000トークン/日
- **コンテキスト**: 200K トークン

#### OpenAI API（本番環境）
- **Rate Limit**: 500リクエスト/分（Tier 1）
- **トークン制限**: 30,000トークン/分（GPT-4o mini）
- **コンテキスト**: 128K トークン
- **コスト**: $0.15/100万入力トークン、$0.60/100万出力トークン

#### Supabase（データベース）
- **無料枠**: 500MB DB、50,000 MAU/月
- **接続制限**: 60同時接続
- **ストレージ**: 1GB
- **注意**: メンター機能追加によりデータ量が増加する可能性あり

#### Vercel（フロントエンドホスティング）
- **無料枠**: 100GBバンドウィズ/月、無制限リクエスト
- **ビルド時間**: 6,000分/月

#### Google Cloud Run（バックエンドホスティング）
- **無料枠**: 200万リクエスト/月、180,000 vCPU秒、360,000 GiB秒メモリ

### 5.2 技術的制約

#### モバイルPWA制約（既存と同じ）
- **iOS Safari**: プッシュ通知非対応、ストレージ制限あり
- **オフライン対応**: Service Workerの容量制限
- **インストール**: ユーザー自身がホーム画面追加する必要

#### パフォーマンス制約
- **AI応答時間**: 3-10秒（ネットワーク状況による）
- **同時AI分析**: Rate Limit考慮で順次処理
- **データベースクエリ**: インデックス最適化必須
- **メンターダッシュボード**: 大量クライアント（100人以上）の場合はページネーション必須

#### セキュリティ制約
- **HTTPS必須**: 本番環境ではHTTPSのみ
- **CORS設定**: フロントエンド-バックエンド間の適切な設定必要
- **環境変数**: APIキーは環境変数管理、Gitにコミットしない
- **監査ログ**: すべてのメンターアクセスを記録（GDPR対応）

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: AI分析レポート生成（既存）

**トリガー**: ユーザーが「AI分析を見る」ボタンをタップ（C-003: 振り返り・改善ページ）

**フロントエンドAPI**: `POST /api/analysis/generate`

**バックエンド内部処理**:
1. ユーザーの指定期間のデータ取得（Goal、Task、Log、Reflection）
2. データを構造化してプロンプト生成
3. AI API（Claude/OpenAI）に分析リクエスト送信
4. AIレスポンスを解析・構造化
5. AIAnalysisReportレコードをDBに保存
6. フロントエンドにレポートを返却

**結果**: AI分析レポート（洞察、推奨事項、信頼度）

**外部サービス依存**: Anthropic Claude API / OpenAI API、Supabase

---

### 複合処理-002: AIチャット応答生成（既存）

**トリガー**: ユーザーがAIアシスタントにメッセージ送信（C-004: AIアシスタント）

**フロントエンドAPI**: `POST /api/chat/message`

**バックエンド内部処理**:
1. ユーザーのメッセージを受信
2. ユーザーのコンテキスト取得（最新の目標、タスク、最近のログ）
3. チャット履歴を取得（直近10件）
4. コンテキスト付きプロンプト生成
5. AI API（Claude/OpenAI）にリクエスト送信
6. AIレスポンスを受信
7. ユーザーメッセージとAIレスポンスをChatMessageとしてDBに保存
8. フロントエンドにAIレスポンスを返却

**結果**: AIの返答メッセージ

**外部サービス依存**: Anthropic Claude API / OpenAI API、Supabase

---

### 複合処理-003: 日次進捗サマリー生成（既存）

**トリガー**: ダッシュボード表示時（C-001: ホーム）

**フロントエンドAPI**: `GET /api/dashboard`

**バックエンド内部処理**:
1. ユーザーの全Goal取得
2. 各Goalの完了タスク数と総タスク数を計算
3. COM:PASS各フェーズの進捗率を計算
4. 今日期限のTaskを抽出
5. 最近のActivityを取得（直近10件）
6. 未読Notificationを取得
7. すべてのデータを統合してDashboardDataとして返却

**結果**: ダッシュボード表示用統合データ

**外部サービス依存**: Supabase

---

### 複合処理-004: メンターダッシュボードデータ生成（新規）

**トリガー**: メンターダッシュボード表示時（M-001: メンターダッシュボード）

**フロントエンドAPI**: `GET /api/mentor/dashboard`

**バックエンド内部処理**:
1. メンターIDで担当クライアント一覧を取得（MentorClientRelationship経由）
2. 各クライアントの以下を計算:
   - 最終活動日（最新のLog、Task、Reflectionの日付）
   - 総合進捗率（COM:PASS各フェーズの平均）
   - ステータス判定（順調/停滞/要フォロー）
3. 統計サマリーを集計:
   - 担当クライアント総数
   - 今週アクティブなクライアント数（7日以内に活動あり）
   - 要フォロークライアント数（7日以上活動なし）
   - 平均進捗率
4. データを統合してMentorDashboardDataとして返却

**結果**: メンターダッシュボード表示用統合データ

**外部サービス依存**: Supabase

---

### 複合処理-005: クライアント詳細データ取得（新規）

**トリガー**: クライアント詳細ページ表示時（M-002: クライアント詳細）

**フロントエンドAPI**: `GET /api/mentor/client/[clientId]`

**バックエンド内部処理**:
1. メンター-クライアント関係を確認（MentorClientRelationship）
2. データアクセス権限を取得（ClientDataAccessPermission）
3. 許可されているデータのみ取得:
   - allowGoals=trueの場合: Goal[]を取得
   - allowTasks=trueの場合: Task[]を取得
   - allowLogs=trueの場合: Log[]を取得
   - allowReflections=trueの場合: Reflection[]を取得
   - allowAiReports=trueの場合: AIAnalysisReport[]を取得
4. 閲覧ログを記録（ClientDataViewLog）
5. クライアント基本情報と許可されたデータを統合して返却

**結果**: クライアント詳細データ（許可されたデータのみ）

**外部サービス依存**: Supabase

---

### 複合処理-006: 進捗レポート生成（新規）

**トリガー**: メンターが「レポート生成」ボタンをクリック（M-002: クライアント詳細）

**フロントエンドAPI**: `POST /api/mentor/report/generate`

**バックエンド内部処理**:
1. メンター-クライアント関係を確認
2. 指定期間のクライアントデータを取得:
   - 完了した目標数
   - 完了したタスク数
   - ログ記録数
   - 振り返り記録数
3. 総合進捗率を計算
4. メンターコメント、評価、改善領域、強みを含めてレポート作成
5. ClientProgressReportレコードをDBに保存
6. フロントエンドにレポートを返却

**結果**: 進捗レポート（統計 + メンター評価）

**外部サービス依存**: Supabase

---

## 7. 技術スタック

### 7.1 フロントエンド（BlueLamp標準）

```yaml
フレームワーク:
  - React 18: モダンなUI構築
  - Next.js 15 (App Router): PWA対応、Server Components
  - TypeScript 5: 型安全性による品質保証

UIライブラリ:
  - TailwindCSS: 最軽量、モバイルファースト
  - shadcn/ui: コピペ可能な高品質コンポーネント集

状態管理:
  - Zustand: 軽量グローバル状態管理

データフェッチ:
  - React Query (TanStack Query): サーバー状態管理

PWA対応:
  - Serwist: Service Worker管理

ビルドツール:
  - Vite 5: 高速開発サーバー
```

### 7.2 バックエンド

```yaml
言語・フレームワーク:
  - Python 3.12
  - FastAPI: 高速、非同期処理、自動ドキュメント生成

ORM:
  - SQLAlchemy: Python標準ORM
  - Alembic: マイグレーション管理
```

### 7.3 データベース

```yaml
メインDB:
  - PostgreSQL 16（Supabase）
  - 理由: 無料枠充実、Auth.js相性良好、JSONBカラム対応

キャッシュ:
  - Redis（必要に応じてUpstash）
```

### 7.4 認証・認可

```yaml
認証システム:
  - Auth.js (NextAuth v5)
  - Prisma Adapter
  - bcrypt: パスワードハッシュ化
  - Data Access Layer (DAL): ロールベース認可
```

### 7.5 AI/ML

```yaml
言語モデル:
  - 開発・テスト: Anthropic Claude 3.5 Sonnet
  - 本番運用: OpenAI GPT-4o mini

データ分析:
  - FastAPI内でカスタム分析ロジック
  - Pandas、NumPy
```

### 7.6 インフラストラクチャ

```yaml
フロントエンド:
  - Vercel（無料枠）

バックエンド:
  - Google Cloud Run（無料枠、サーバーレス）

データベース:
  - Supabase（無料枠）

CI/CD:
  - GitHub Actions

モニタリング:
  - Sentry（無料枠: 5,000 errors/月）

メール送信:
  - Resend（無料枠: 100通/日）
```

---

## 8. 必要な外部サービス・アカウント

### 8.1 必須サービス（既存と同じ）

| サービス名 | 用途 | 取得先 | 料金 | 備考 |
|-----------|------|--------|------|------|
| **Anthropic Claude API** | 開発・テスト時のAI分析・アドバイス生成 | https://console.anthropic.com | $10無料枠、その後従量課金 | クレジットカード登録必須 |
| **OpenAI API** | 本番運用時のAI分析・アドバイス生成 | https://platform.openai.com | $5最低入金、従量課金 | GPT-4o mini推奨 |
| **Supabase** | PostgreSQLデータベース、認証基盤 | https://supabase.com | 無料枠、$10/月〜 | GitHub連携推奨 |
| **Vercel** | フロントエンドホスティング | https://vercel.com | 無料枠、$20/月〜 | GitHub連携推奨 |
| **Google Cloud** | バックエンドホスティング（Cloud Run） | https://cloud.google.com | 無料枠、従量課金 | $300初回クレジットあり |

### 8.2 オプションサービス（既存と同じ）

| サービス名 | 用途 | 取得先 | 料金 | 備考 |
|-----------|------|--------|------|------|
| **Resend** | パスワードリセットメール送信 | https://resend.com | 無料枠（100通/日）、$20/月〜 | Next.js推奨 |
| **Sentry** | エラーモニタリング | https://sentry.io | 無料枠（5,000 errors/月）、$29/月〜 | 問題の早期発見 |
| **Upstash Redis** | キャッシュ・セッション管理 | https://upstash.com | 無料枠（10,000コマンド/日）、$0.2/100K〜 | サーバーレスRedis |
| **Cloudinary** | 画像アップロード・最適化 | https://cloudinary.com | 無料枠（25GB/月）、$99/月〜 | プロフィール画像等 |

### 8.3 概算コスト

| 項目 | 初期費用 | 月額（開発） | 月額（本番20ユーザー） |
|------|---------|-------------|---------------------|
| Claude API | 無料 | 無料（$10枠内） | - |
| OpenAI API | $5（約750円） | - | 約100円 |
| Supabase | 無料 | 無料 | 無料 |
| Vercel | 無料 | 無料 | 無料 |
| Google Cloud | 無料（$300クレジット） | 無料（枠内） | 無料〜$5 |
| Resend | 無料 | 無料 | 無料 |
| **合計** | **約750円** | **無料** | **約100円〜$5** |

**注**: メンター機能追加により、データベース使用量が増加する可能性がありますが、無料枠内で収まる見込みです。

---

## 9. 今後の拡張予定（フェーズ3以降）

フェーズ2で検証した価値に基づき、以下の機能を段階的に追加予定：

### フェーズ3: メッセージング & AI自動アラート
- メンター-クライアント間リアルタイムメッセージング
- AI自動アラート（クライアント停滞検知、介入提案）
- プッシュ通知機能
- ファイル共有機能

### フェーズ4: 組織管理機能
- 組織単位でのクライアント・メンター管理
- 組織全体のデータ分析ダッシュボード
- 組織管理者（ADMIN）ロールの追加
- ロール・権限管理の拡張

### フェーズ5: 高度なAI機能
- AIのパーソナライゼーション機能の高度化
- 予測分析（目標達成確率の予測）
- 自動リマインダー最適化
- メンター向けAIコーチングアシスタント

### フェーズ6: 外部連携
- 外部ウェアラブルデバイスとの連携
- カレンダー連携（Google Calendar等）
- 他のタスク管理ツールとの連携
- Slack/Teams連携

---

## 10. 開発スケジュール目安

### フェーズ2開発期間: 2-4週間

| フェーズ | 期間 | 主な作業 |
|---------|------|---------|
| **Week 1** | 基盤整備 | Prismaスキーマ拡張、Auth.jsロール機能追加、DAL拡張、マイグレーション |
| **Week 2** | メンターページ実装 | M-001: メンターダッシュボード、M-002: クライアント詳細、API実装 |
| **Week 3** | データアクセス制御 | 権限チェック機能、閲覧ログ、C-005拡張（メンター登録） |
| **Week 4** | テスト・デバッグ・デプロイ | E2Eテスト、バグ修正、本番デプロイ、ユーザーテスト |

---

## 11. 成功の定義

このフェーズ2が成功したと判断する基準：

### 定量的基準
1. **5人のメンターが合計50人のクライアントを管理できる**（1人あたり10人）
2. **メンターがクライアント全体の状況確認を5分以内で完了できる**
3. **メンターの週次作業時間が3時間以内で完結する**
4. **クライアントの90%がメンターにデータアクセス許可を付与する**
5. **メンターが週1回以上、各クライアントをチェックできる**

### 定性的基準
1. **メンターが「クライアント全体を一目で把握できる」とフィードバック**
2. **メンターが「優先対応者を判断しやすい」と評価**
3. **クライアントが「適切なタイミングでサポートを受けられた」と実感**
4. **メンターが「データアクセス制御が適切で安心できる」と感じる**
5. **メンターとクライアントが「この仕組みなら長期的に続けられる」と感じる**

---

**要件定義書 完**

次のステップ: モックアップ作成 → 開発開始
