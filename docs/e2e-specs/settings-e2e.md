# Settings E2Eテスト仕様書

生成日: 2025-11-01
対象ページ: /settings (設定ページ)
テスト環境: モック実装
作成者: E2Eテスト仕様書作成エージェント

## 概要

- 総テスト項目数: 58項目
- 高優先度: 25項目
- 中優先度: 22項目
- 低優先度: 11項目

## 分析対象ファイル

- app/(protected)/settings/page.tsx
- lib/services/SettingsService.ts
- hooks/useSettingsData.ts
- types/index.ts
- docs/api-specs/settings-api.md

## テスト項目一覧

| No | テストID | テスト項目 | 依存テストID | 機能分類 | テスト分類 | 優先度 | 確認内容 | テストデータ/手順 | 期待結果 | 実施日 | 結果 | 備考 |
|----|---------|----------|------------|---------|-----------|--------|---------|------------------|----------|--------|------|------|
| 1 | E2E-SET-001 | 設定ページ初期アクセス | なし | ページアクセス | 正常系 | 高 | ページが正常に表示される | 1. ブラウザで`http://localhost:3247/settings`にアクセス | ・設定ページが表示<br>・ローディング表示後にコンテンツが表示<br>・エラーなし | | | |
| 2 | E2E-SET-002 | プロフィール情報表示 | E2E-SET-001 | データ表示 | 正常系 | 高 | モックユーザー情報が正しく表示される | 1. 設定ページにアクセス<br>2. プロフィールセクションを確認 | ・「プロフィール」見出し表示<br>・名前フィールドに「田中 太郎」が入力済み<br>・メールアドレスフィールドに「test@mentalbase.local」が入力済み | | | |
| 3 | E2E-SET-003 | 通知設定表示 | E2E-SET-001 | データ表示 | 正常系 | 高 | 通知設定が正しく表示される | 1. 設定ページにアクセス<br>2. 通知設定セクションを確認 | ・「通知設定」見出し表示<br>・メール通知トグルが有効（ON）状態<br>・説明文「重要なお知らせやリマインダーをメールで受け取る」表示 | | | |
| 4 | E2E-SET-004 | パスワード変更フォーム表示 | E2E-SET-001 | データ表示 | 正常系 | 高 | パスワード変更フォームが表示される | 1. 設定ページにアクセス<br>2. パスワード変更セクションを確認 | ・「パスワード変更」見出し表示<br>・現在のパスワード入力フィールド表示<br>・新しいパスワード入力フィールド表示<br>・新しいパスワード（確認）入力フィールド表示<br>・パスワードを変更ボタン表示 | | | |
| 5 | E2E-SET-005 | アカウント管理セクション表示 | E2E-SET-001 | データ表示 | 正常系 | 高 | アカウント削除セクションが表示される | 1. 設定ページにアクセス<br>2. アカウント管理セクションを確認 | ・「アカウント管理」見出し表示<br>・赤枠の危険ゾーン表示<br>・警告アイコンと「危険な操作」テキスト表示<br>・説明文「アカウントを削除すると、すべてのデータが完全に削除されます。この操作は取り消せません。」表示<br>・アカウントを削除ボタン（赤色）表示 | | | |
| 6 | E2E-SET-006 | プロフィール更新（正常） | E2E-SET-002 | プロフィール更新 | 正常系 | 高 | プロフィールを正常に更新できる | 1. 名前を「佐藤 花子」に変更<br>2. メールアドレスを「sato@example.com」に変更<br>3. プロフィールを保存ボタンをクリック | ・ボタンクリック可能<br>・API呼び出し（updateProfile）実行<br>・成功メッセージ「プロフィールが更新されました」表示（緑背景）<br>・3秒後にメッセージが自動で消える<br>・フォームに新しい情報が反映 | | | |
| 7 | E2E-SET-007 | プロフィール更新（名前空欄） | E2E-SET-002 | プロフィール更新 | 異常系 | 高 | 名前が空欄の場合エラー表示 | 1. 名前を空欄にする<br>2. プロフィールを保存ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「名前を入力してください」表示（赤背景）<br>・プロフィールは更新されない | | | |
| 8 | E2E-SET-008 | プロフィール更新（無効なメール形式） | E2E-SET-002 | プロフィール更新 | 異常系 | 高 | 無効なメール形式の場合エラー表示 | 1. メールアドレスを「invalid-email」に変更<br>2. プロフィールを保存ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「有効なメールアドレスを入力してください」表示（赤背景）<br>・プロフィールは更新されない | | | |
| 9 | E2E-SET-009 | パスワード変更（正常） | E2E-SET-004 | パスワード変更 | 正常系 | 高 | パスワードを正常に変更できる | 1. 現在のパスワードに「OldPassword123!」を入力<br>2. 新しいパスワードに「NewPassword456!」を入力<br>3. 新しいパスワード（確認）に「NewPassword456!」を入力<br>4. パスワードを変更ボタンをクリック | ・API呼び出し（changePassword）実行<br>・成功メッセージ「パスワードが変更されました」表示（緑背景）<br>・3秒後にメッセージが自動で消える<br>・全入力フィールドがクリアされる | | | |
| 10 | E2E-SET-010 | パスワード変更（全フィールド空欄） | E2E-SET-004 | パスワード変更 | 異常系 | 高 | 全フィールドが空欄の場合エラー表示 | 1. 全フィールドを空欄のまま<br>2. パスワードを変更ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「すべてのフィールドを入力してください」表示（赤背景）<br>・パスワードは変更されない | | | |
| 11 | E2E-SET-011 | パスワード変更（8文字未満） | E2E-SET-004 | パスワード変更 | 異常系 | 高 | 新しいパスワードが8文字未満の場合エラー表示 | 1. 現在のパスワードに「OldPassword123!」を入力<br>2. 新しいパスワードに「Short1!」（7文字）を入力<br>3. 新しいパスワード（確認）に「Short1!」を入力<br>4. パスワードを変更ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「新しいパスワードは8文字以上で入力してください」表示（赤背景）<br>・パスワードは変更されない | | | |
| 12 | E2E-SET-012 | パスワード変更（確認パスワード不一致） | E2E-SET-004 | パスワード変更 | 異常系 | 高 | 確認パスワードが一致しない場合エラー表示 | 1. 現在のパスワードに「OldPassword123!」を入力<br>2. 新しいパスワードに「NewPassword456!」を入力<br>3. 新しいパスワード（確認）に「DifferentPassword789!」を入力<br>4. パスワードを変更ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「新しいパスワードが一致しません」表示（赤背景）<br>・パスワードは変更されない | | | |
| 13 | E2E-SET-013 | メール通知ON→OFF切り替え | E2E-SET-003 | 通知設定変更 | 正常系 | 高 | メール通知をOFFにできる | 1. メール通知トグルをクリック | ・トグルがOFF状態に変化<br>・API呼び出し（updateNotificationSettings）実行<br>・成功メッセージ「メール通知を無効にしました」表示（緑背景）<br>・3秒後にメッセージが自動で消える | | | |
| 14 | E2E-SET-014 | メール通知OFF→ON切り替え | E2E-SET-013 | 通知設定変更 | 正常系 | 高 | メール通知をONにできる | 1. OFF状態のメール通知トグルをクリック | ・トグルがON状態に変化<br>・API呼び出し実行<br>・成功メッセージ「メール通知を有効にしました」表示（緑背景）<br>・3秒後にメッセージが自動で消える | | | |
| 15 | E2E-SET-015 | 通知設定変更（APIエラー） | E2E-SET-003 | 通知設定変更 | 異常系 | 高 | 通知設定APIエラー時にトグルを元に戻す | 1. モックでエラーをthrow<br>2. メール通知トグルをクリック | ・トグルが一瞬変化後、元の状態に戻る<br>・エラーメッセージ表示（赤背景）<br>・API呼び出し実行<br>・設定は変更されない | | | モック変更必要 |
| 16 | E2E-SET-016 | アカウント削除モーダル表示 | E2E-SET-005 | アカウント削除 | 正常系 | 高 | アカウント削除ボタンでモーダルが開く | 1. アカウントを削除ボタンをクリック | ・モーダルが表示される<br>・モーダルタイトル「アカウント削除の確認」表示<br>・警告文「本当にアカウントを削除しますか？この操作は取り消せません。すべてのデータが完全に削除されます。」表示<br>・キャンセルボタン表示<br>・削除するボタン（赤色）表示<br>・背景が暗くなる（bg-opacity-50） | | | |
| 17 | E2E-SET-017 | アカウント削除モーダルキャンセル | E2E-SET-016 | アカウント削除 | 正常系 | 高 | モーダルをキャンセルできる | 1. アカウント削除モーダルを表示<br>2. キャンセルボタンをクリック | ・モーダルが閉じる<br>・設定ページに戻る<br>・アカウントは削除されない | | | |
| 18 | E2E-SET-018 | アカウント削除モーダル背景クリックで閉じる | E2E-SET-016 | アカウント削除 | 正常系 | 中 | モーダル背景クリックでモーダルが閉じる | 1. アカウント削除モーダルを表示<br>2. モーダル外（背景）をクリック | ・モーダルが閉じる<br>・設定ページに戻る<br>・アカウントは削除されない | | | |
| 19 | E2E-SET-019 | アカウント削除実行 | E2E-SET-016 | アカウント削除 | 正常系 | 高 | アカウントを削除できる | 1. アカウント削除モーダルを表示<br>2. 削除するボタンをクリック | ・API呼び出し（deleteAccount）実行<br>・アラート「アカウントが削除されました。ログアウトします。」表示<br>・ログインページ（/auth/login）にリダイレクト | | | |
| 20 | E2E-SET-020 | アカウント削除APIエラー | E2E-SET-016 | アカウント削除 | 異常系 | 高 | アカウント削除APIエラー時のエラー表示 | 1. モックでエラーをthrow<br>2. アカウント削除モーダルを表示<br>3. 削除するボタンをクリック | ・API呼び出し実行<br>・モーダルが閉じる<br>・エラーメッセージ表示（赤背景）<br>・アカウントは削除されない | | | モック変更必要 |
| 21 | E2E-SET-021 | ローディング状態表示 | なし | ローディング | 正常系 | 高 | データ取得中はローディング表示 | 1. 設定ページアクセス時<br>2. データ取得前の状態を確認 | ・スピナーアニメーション表示<br>・「読み込み中...」テキスト表示<br>・コンテンツは表示されない | | | 300msのdelayで確認可能 |
| 22 | E2E-SET-022 | API接続エラー表示 | なし | エラー処理 | 異常系 | 高 | API接続エラー時のエラー表示 | 1. モックサービスでエラーをthrow<br>2. 設定ページにアクセス | ・赤背景のエラーボックス表示<br>・「エラーが発生しました: [エラーメッセージ]」表示<br>・設定フォームは表示されない | | | モック変更必要 |
| 23 | E2E-SET-023 | 成功メッセージ表示 | E2E-SET-006 | メッセージ表示 | 正常系 | 中 | 成功メッセージが適切に表示される | 1. プロフィールを更新<br>2. 成功メッセージを確認 | ・緑背景のメッセージボックス表示<br>・チェックアイコン（check_circle）表示<br>・成功メッセージテキスト表示<br>・3秒後に自動で消える | | | |
| 24 | E2E-SET-024 | エラーメッセージ表示 | E2E-SET-007 | メッセージ表示 | 正常系 | 中 | エラーメッセージが適切に表示される | 1. 無効なデータでプロフィールを更新<br>2. エラーメッセージを確認 | ・赤背景のメッセージボックス表示<br>・エラーアイコン（error）表示<br>・エラーメッセージテキスト表示 | | | |
| 25 | E2E-SET-025 | プロフィール名前フィールド入力 | E2E-SET-002 | 入力操作 | 正常系 | 中 | 名前フィールドに入力できる | 1. 名前フィールドをクリック<br>2. 「新しい名前」と入力 | ・フィールドがフォーカス状態<br>・入力した内容が表示される<br>・フォーカス時にボーダーが primary カラーに変化 | | | |
| 26 | E2E-SET-026 | プロフィールメールフィールド入力 | E2E-SET-002 | 入力操作 | 正常系 | 中 | メールフィールドに入力できる | 1. メールフィールドをクリック<br>2. 「new@example.com」と入力 | ・フィールドがフォーカス状態<br>・入力した内容が表示される<br>・フォーカス時にボーダーが primary カラーに変化 | | | |
| 27 | E2E-SET-027 | パスワードフィールドの非表示 | E2E-SET-004 | 入力操作 | 正常系 | 中 | パスワード入力時に文字が非表示になる | 1. 現在のパスワードフィールドをクリック<br>2. 「password123」と入力 | ・入力文字が「•••••••••」などでマスキング表示<br>・type="password"が正しく動作 | | | |
| 28 | E2E-SET-028 | プロフィール保存ボタンの視覚フィードバック | E2E-SET-006 | ボタン操作 | 正常系 | 低 | ボタンクリック時の視覚フィードバック | 1. プロフィールを保存ボタンをクリック | ・ボタンがactive:scale-[0.98]で縮小アニメーション<br>・ホバー時にボタンの色が変化<br>・アイコン（save）が表示 | | | |
| 29 | E2E-SET-029 | パスワード変更ボタンの視覚フィードバック | E2E-SET-009 | ボタン操作 | 正常系 | 低 | ボタンクリック時の視覚フィードバック | 1. パスワードを変更ボタンをクリック | ・ボタンがactive:scale-[0.98]で縮小アニメーション<br>・ホバー時にボタンの色が変化<br>・アイコン（lock）が表示 | | | |
| 30 | E2E-SET-030 | アカウント削除ボタンの視覚フィードバック | E2E-SET-016 | ボタン操作 | 正常系 | 低 | ボタンクリック時の視覚フィードバック | 1. アカウントを削除ボタンをクリック | ・ボタンがactive:scale-[0.98]で縮小アニメーション<br>・ホバー時に赤色が濃くなる（bg-red-600）<br>・アイコン（delete_forever）が表示 | | | |
| 31 | E2E-SET-031 | トグルスイッチアニメーション | E2E-SET-013 | ボタン操作 | 正常系 | 低 | トグルスイッチがスムーズにアニメーション | 1. メール通知トグルをクリック<br>2. アニメーションを確認 | ・トグルボタンがスムーズに右（ON）→左（OFF）に移動<br>・背景色が success → border-dark に変化<br>・transition-all が適用 | | | |
| 32 | E2E-SET-032 | ネットワーク切断時の挙動 | E2E-SET-001 | エラー処理 | 異常系 | 中 | ネットワーク切断時のエラー処理 | 1. DevToolsでオフラインに設定<br>2. 設定ページにアクセス | ・ネットワークエラー表示<br>・エラーメッセージ表示<br>・リトライ可能 | | | |
| 33 | E2E-SET-033 | APIタイムアウト処理 | E2E-SET-001 | エラー処理 | 異常系 | 低 | API応答遅延時の挙動 | 1. モックdelayを30秒以上に設定<br>2. 設定ページにアクセス | ・30秒以上ローディング表示<br>・タイムアウト処理（実装予定）<br>・エラー表示またはリトライ提案 | | | タイムアウト機能未実装 |
| 34 | E2E-SET-034 | 不正なデータ形式エラー | E2E-SET-001 | エラー処理 | 異常系 | 中 | 想定外のデータ形式の処理 | 1. モックで不正な型のデータを返却<br>2. 設定ページにアクセス | ・TypeScriptエラーまたはランタイムエラー<br>・エラーバウンダリでキャッチ（実装予定）<br>・ユーザーフレンドリーなエラー表示 | | | エラーバウンダリ未実装 |
| 35 | E2E-SET-035 | プロフィール更新（メール重複） | E2E-SET-002 | プロフィール更新 | 異常系 | 中 | 既存ユーザーのメールアドレスを使用した場合 | 1. メールアドレスを既存ユーザーのものに変更<br>2. プロフィールを保存ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「このメールアドレスは既に使用されています」表示（赤背景）<br>・プロフィールは更新されない | | | 本番API実装時に対応 |
| 36 | E2E-SET-036 | パスワード変更（現在のパスワード不正） | E2E-SET-004 | パスワード変更 | 異常系 | 中 | 現在のパスワードが間違っている場合 | 1. 現在のパスワードに「WrongPassword123!」を入力<br>2. 新しいパスワードに「NewPassword456!」を入力<br>3. 新しいパスワード（確認）に「NewPassword456!」を入力<br>4. パスワードを変更ボタンをクリック | ・API呼び出し実行<br>・エラーメッセージ「現在のパスワードが正しくありません」表示（赤背景）<br>・パスワードは変更されない | | | 本番API実装時に対応 |
| 37 | E2E-SET-037 | 認証なしアクセス | なし | セキュリティ | セキュリティ | 高 | 未認証ユーザーのアクセス制御 | 1. 認証情報なしで`/settings`にアクセス | ・現在はモックユーザーで動作<br>・将来的には認証ページ（`/auth`）にリダイレクト | | | 認証未実装 |
| 38 | E2E-SET-038 | セッション期限切れ | E2E-SET-001 | セキュリティ | セキュリティ | 高 | セッション期限切れ時の挙動 | 1. セッションを期限切れに設定<br>2. 設定ページで操作 | ・セッション期限切れ検知<br>・認証ページにリダイレクト<br>・現在のURLを保持してリダイレクト後に復帰 | | | 認証未実装 |
| 39 | E2E-SET-039 | CSRF攻撃対策 | E2E-SET-006 | セキュリティ | セキュリティ | 高 | プロフィール更新時のCSRF対策 | 1. CSRFトークンなしでAPI呼び出し | ・CSRFトークン検証（Auth.js対応）<br>・不正なリクエストは拒否<br>・エラーメッセージ表示 | | | Auth.js実装時に対応 |
| 40 | E2E-SET-040 | 他ユーザーのデータ取得試行 | E2E-SET-001 | セキュリティ | セキュリティ | 高 | 他ユーザーの設定情報へのアクセス制御 | 1. 他ユーザーのuserIdでAPI呼び出し試行 | ・403 Forbiddenエラー<br>・エラーメッセージ「権限がありません」表示<br>・データは取得できない | | | 本番API実装時に対応 |
| 41 | E2E-SET-041 | パスワード変更時のセキュリティ強度チェック | E2E-SET-004 | セキュリティ | セキュリティ | 中 | 脆弱なパスワードの検出 | 1. 新しいパスワードに「password」を入力<br>2. 新しいパスワード（確認）に「password」を入力<br>3. パスワードを変更ボタンをクリック | ・パスワード強度チェック実行（実装予定）<br>・警告メッセージ「より強固なパスワードを推奨します」表示<br>・英数字+記号の組み合わせを推奨 | | | パスワード強度チェック未実装 |
| 42 | E2E-SET-042 | アカウント削除時のトランザクション処理 | E2E-SET-019 | セキュリティ | セキュリティ | 高 | 関連データの一括削除確認 | 1. アカウントを削除<br>2. バックエンドログを確認 | ・トランザクション開始<br>・Goal、Task、Log、Reflection、AIAnalysisReport、ActionPlan、ChatMessage、Notification、UserSettings、Session、User の順に削除<br>・削除失敗時は全ロールバック<br>・トランザクション完了 | | | 本番API実装時に確認 |
| 43 | E2E-SET-043 | デスクトップ表示（1920x1080） | E2E-SET-001 | レスポンシブ | レスポンシブ | 高 | デスクトップ表示の確認 | 1. ブラウザを1920x1080にリサイズ<br>2. 設定ページを確認 | ・各セクションが適切な幅で表示<br>・フォームが中央寄せまたは適切な幅で表示<br>・px-6、py-6の余白が適用<br>・カードが見やすい | | | |
| 44 | E2E-SET-044 | タブレット表示（768x1024） | E2E-SET-001 | レスポンシブ | レスポンシブ | 高 | タブレット表示の確認 | 1. ブラウザを768x1024にリサイズ<br>2. 設定ページを確認 | ・各セクションが適切にリサイズ<br>・入力フィールドが読みやすい<br>・ボタンがタップしやすい<br>・文字サイズが適切 | | | |
| 45 | E2E-SET-045 | モバイル表示（375x667） | E2E-SET-001 | レスポンシブ | レスポンシブ | 高 | モバイル表示の確認 | 1. ブラウザを375x667にリサイズ<br>2. 設定ページを確認 | ・各セクションが縦積み<br>・入力フィールドが画面幅に適応<br>・タッチターゲットが44px以上<br>・横スクロールなし<br>・ボタンが幅100%（w-full） | | | |
| 46 | E2E-SET-046 | タッチジェスチャー対応 | E2E-SET-045 | レスポンシブ | レスポンシブ | 中 | モバイルでのタッチ操作確認 | 1. モバイルデバイスまたはエミュレータでアクセス<br>2. トグルスイッチをタップ | ・タップ操作が正確に反応<br>・active:scale-[0.98]のアニメーション動作<br>・誤タップが発生しない | | | |
| 47 | E2E-SET-047 | 縦向き・横向き切り替え | E2E-SET-045 | レスポンシブ | レスポンシブ | 低 | デバイス回転時の表示確認 | 1. モバイルデバイスで縦向き表示<br>2. 横向きに回転 | ・レイアウトが自動調整<br>・コンテンツが切れない<br>・スクロール可能<br>・モーダルが適切に表示 | | | |
| 48 | E2E-SET-048 | プロフィール・パスワード連続更新 | E2E-SET-006, E2E-SET-009 | ワークフロー | ワークフロー | 高 | プロフィールとパスワードを連続で更新できる | 1. プロフィールを更新<br>2. 成功メッセージを確認<br>3. パスワードを変更<br>4. 成功メッセージを確認 | ・両方の更新が正常に実行される<br>・それぞれで成功メッセージが表示<br>・エラーなし | | | |
| 49 | E2E-SET-049 | 通知設定とプロフィール連続更新 | E2E-SET-006, E2E-SET-013 | ワークフロー | ワークフロー | 中 | 通知設定とプロフィールを連続で更新できる | 1. メール通知をOFFにする<br>2. 成功メッセージを確認<br>3. プロフィールを更新<br>4. 成功メッセージを確認 | ・両方の更新が正常に実行される<br>・それぞれで成功メッセージが表示<br>・エラーなし | | | |
| 50 | E2E-SET-050 | ページリロード後の状態保持 | E2E-SET-006 | ワークフロー | ワークフロー | 中 | ページリロード後も変更が保持される | 1. プロフィールを更新<br>2. ブラウザをリロード | ・更新したプロフィール情報が表示<br>・通知設定が保持される<br>・エラーなし | | | モックデータはリセットされる |
| 51 | E2E-SET-051 | 長い名前の表示 | E2E-SET-002 | UI表示 | エッジケース | 中 | 長い名前が適切に表示される | 1. 名前に100文字以上の文字列を入力<br>2. プロフィールを保存 | ・名前が折り返し表示またはスクロール<br>・フォームがはみ出さない<br>・省略記号（...）表示（実装予定） | | | 省略表示未実装 |
| 52 | E2E-SET-052 | 長いメールアドレスの表示 | E2E-SET-002 | UI表示 | エッジケース | 中 | 長いメールアドレスが適切に表示される | 1. メールアドレスに100文字以上の文字列を入力<br>2. プロフィールを保存 | ・メールアドレスが折り返し表示またはスクロール<br>・フォームがはみ出さない<br>・省略記号（...）表示（実装予定） | | | 省略表示未実装 |
| 53 | E2E-SET-053 | 特殊文字を含む名前 | E2E-SET-002 | UI表示 | エッジケース | 低 | 特殊文字を含む名前が正しく処理される | 1. 名前に「田中<太郎>」を入力<br>2. プロフィールを保存 | ・特殊文字がエスケープされる<br>・XSS攻撃が防止される<br>・エラーなし | | | サニタイズ確認必要 |
| 54 | E2E-SET-054 | 空白のみの名前 | E2E-SET-002 | UI表示 | エッジケース | 中 | 空白のみの名前がエラーになる | 1. 名前に「   」（空白のみ）を入力<br>2. プロフィールを保存 | ・エラーメッセージ「名前を入力してください」表示<br>・trim()処理が適用される | | | |
| 55 | E2E-SET-055 | モーダル内のイベント伝播防止 | E2E-SET-016 | UI表示 | エッジケース | 低 | モーダル内クリックが背景に伝播しない | 1. アカウント削除モーダルを表示<br>2. モーダル内のコンテンツをクリック | ・モーダルが閉じない<br>・e.stopPropagation()が動作<br>・意図しない操作が発生しない | | | |
| 56 | E2E-SET-056 | 成功メッセージの自動消去タイマー | E2E-SET-006 | UI表示 | エッジケース | 低 | 成功メッセージが3秒後に消える | 1. プロフィールを更新<br>2. 成功メッセージが表示される<br>3. 3秒待つ | ・メッセージが3秒後に自動で消える<br>・setTimeout処理が正常動作 | | | |
| 57 | E2E-SET-057 | 複数の成功メッセージ上書き | E2E-SET-048 | UI表示 | エッジケース | 低 | 連続操作時に最新の成功メッセージが表示される | 1. プロフィールを更新<br>2. すぐにパスワードを変更 | ・最新の成功メッセージが表示<br>・古いメッセージは上書きされる<br>・メッセージが重複表示されない | | | |
| 58 | E2E-SET-058 | エラーメッセージと成功メッセージの排他制御 | E2E-SET-006, E2E-SET-007 | UI表示 | エッジケース | 低 | エラーと成功メッセージが同時に表示されない | 1. 無効なデータでプロフィールを更新（エラー）<br>2. 正しいデータでプロフィールを更新（成功） | ・エラーメッセージが消える<br>・成功メッセージのみが表示<br>・メッセージが重複しない | | | |

## テスト分類別カバレッジ

- 正常系: 22項目（38%）
  - ページアクセス、データ表示、プロフィール更新、パスワード変更、通知設定変更、アカウント削除、入力操作、ボタン操作
- 異常系: 14項目（24%）
  - バリデーションエラー、APIエラー、ネットワークエラー、データ形式エラー
- セキュリティ: 9項目（16%）
  - 認証、セッション、CSRF、アクセス制御、トランザクション処理、パスワード強度
- レスポンシブ: 5項目（9%）
  - デスクトップ、タブレット、モバイル、タッチ操作、画面回転
- ワークフロー: 3項目（5%）
  - 連続操作、状態保持
- エッジケース: 8項目（14%）
  - 長いテキスト、特殊文字、空白、イベント伝播、メッセージ管理

## API呼び出し一覧

| No | メソッド | エンドポイント | 用途 | テストID | モック実装 |
|----|---------|--------------|------|----------|-----------|
| 1 | GET | /api/users/profile | プロフィール情報取得 | E2E-SET-001, 002 | SettingsService.getProfile() |
| 2 | PUT | /api/users/profile | プロフィール情報更新 | E2E-SET-006-008, 035 | SettingsService.updateProfile() |
| 3 | POST | /api/users/password | パスワード変更 | E2E-SET-009-012, 036 | SettingsService.changePassword() |
| 4 | GET | /api/users/settings | ユーザー設定取得 | E2E-SET-001, 003 | SettingsService.getSettings() |
| 5 | PUT | /api/users/settings | 通知設定更新 | E2E-SET-013-015 | SettingsService.updateNotificationSettings() |
| 6 | DELETE | /api/users/account | アカウント削除 | E2E-SET-019-020, 042 | SettingsService.deleteAccount() |

## 優先度別実施順序

### 高優先度（必須）: 25項目
実施順序（依存関係に基づく）:
1. E2E-SET-001（設定ページ初期アクセス）- 依存なし
2. E2E-SET-021（ローディング状態表示）- 依存なし
3. E2E-SET-037（認証なしアクセス）- 依存なし
4. E2E-SET-002（プロフィール情報表示）
5. E2E-SET-003（通知設定表示）
6. E2E-SET-004（パスワード変更フォーム表示）
7. E2E-SET-005（アカウント管理セクション表示）
8. E2E-SET-006（プロフィール更新（正常））
9. E2E-SET-007（プロフィール更新（名前空欄））
10. E2E-SET-008（プロフィール更新（無効なメール形式））
11. E2E-SET-009（パスワード変更（正常））
12. E2E-SET-010（パスワード変更（全フィールド空欄））
13. E2E-SET-011（パスワード変更（8文字未満））
14. E2E-SET-012（パスワード変更（確認パスワード不一致））
15. E2E-SET-013（メール通知ON→OFF切り替え）
16. E2E-SET-014（メール通知OFF→ON切り替え）
17. E2E-SET-015（通知設定変更（APIエラー））
18. E2E-SET-016（アカウント削除モーダル表示）
19. E2E-SET-017（アカウント削除モーダルキャンセル）
20. E2E-SET-019（アカウント削除実行）
21. E2E-SET-020（アカウント削除APIエラー）
22. E2E-SET-022（API接続エラー表示）
23. E2E-SET-038（セッション期限切れ）
24. E2E-SET-039（CSRF攻撃対策）
25. E2E-SET-040（他ユーザーのデータ取得試行）
26. E2E-SET-042（アカウント削除時のトランザクション処理）
27. E2E-SET-043（デスクトップ表示）
28. E2E-SET-044（タブレット表示）
29. E2E-SET-045（モバイル表示）
30. E2E-SET-048（プロフィール・パスワード連続更新）

### 中優先度（推奨）: 22項目
実施順序:
1. E2E-SET-018（アカウント削除モーダル背景クリックで閉じる）
2. E2E-SET-023（成功メッセージ表示）
3. E2E-SET-024（エラーメッセージ表示）
4. E2E-SET-025（プロフィール名前フィールド入力）
5. E2E-SET-026（プロフィールメールフィールド入力）
6. E2E-SET-027（パスワードフィールドの非表示）
7. E2E-SET-032（ネットワーク切断時の挙動）
8. E2E-SET-034（不正なデータ形式エラー）
9. E2E-SET-035（プロフィール更新（メール重複））
10. E2E-SET-036（パスワード変更（現在のパスワード不正））
11. E2E-SET-041（パスワード変更時のセキュリティ強度チェック）
12. E2E-SET-046（タッチジェスチャー対応）
13. E2E-SET-049（通知設定とプロフィール連続更新）
14. E2E-SET-050（ページリロード後の状態保持）
15. E2E-SET-051（長い名前の表示）
16. E2E-SET-052（長いメールアドレスの表示）
17. E2E-SET-054（空白のみの名前）

### 低優先度（任意）: 11項目
実施順序:
1. E2E-SET-028（プロフィール保存ボタンの視覚フィードバック）
2. E2E-SET-029（パスワード変更ボタンの視覚フィードバック）
3. E2E-SET-030（アカウント削除ボタンの視覚フィードバック）
4. E2E-SET-031（トグルスイッチアニメーション）
5. E2E-SET-033（APIタイムアウト処理）
6. E2E-SET-047（縦向き・横向き切り替え）
7. E2E-SET-053（特殊文字を含む名前）
8. E2E-SET-055（モーダル内のイベント伝播防止）
9. E2E-SET-056（成功メッセージの自動消去タイマー）
10. E2E-SET-057（複数の成功メッセージ上書き）
11. E2E-SET-058（エラーメッセージと成功メッセージの排他制御）

## 前提条件

### テストアカウント
- モックユーザー:
  - ID: user1
  - Email: test@mentalbase.local
  - Name: 田中 太郎
  - Created: 2025-10-01T00:00:00
  - Updated: 2025-11-01T00:00:00

### テストデータ
- ユーザー設定:
  - メール通知: 有効（true）
  - リマインダー時刻: 09:00
  - テーマ: professional
  - 更新日時: 2025-11-01T00:00:00

### テスト環境
- ブラウザ: Chrome, Safari, Firefox最新版
- 画面サイズ: 1920x1080（デスクトップ）、768x1024（タブレット）、375x667（モバイル）
- ネットワーク: 高速、低速、オフライン
- 開発サーバー: http://localhost:3247

## 実装されている機能

### 完全実装済み
- 設定ページ基本レイアウト
- プロフィール情報表示・更新フォーム
- パスワード変更フォーム
- 通知設定（メール通知トグル）
- アカウント削除機能（モーダル付き）
- 成功メッセージ表示（自動消去）
- エラーメッセージ表示
- ローディング状態表示
- エラー状態表示
- カスタムフック（useSettingsData）
- モックサービス（SettingsService）
- バリデーション（名前、メール、パスワード）

### 未実装（将来対応）
- 認証機能
- エラーバウンダリ
- タイムアウト処理
- 長いテキストの省略表示
- パスワード強度チェック
- メールアドレス重複チェック（本番API）
- 現在のパスワード検証（本番API）
- リマインダー時刻設定UI
- テーマ設定UI
- アカウント削除時のバックアップ

## セキュリティ考慮事項

### 現在の課題
1. **認証未実装**: モックユーザーで動作中
   - 対策: Auth.js（NextAuth v5）導入
2. **CSRF対策未実装**:
   - 対策: Auth.jsのCSRFトークン機能を活用
3. **パスワード強度チェック未実装**:
   - 対策: zxcvbnなどのライブラリ導入
4. **アカウント削除の本人確認不足**:
   - 対策: 現在のパスワード入力を追加

### 実装予定の対策
- Auth.js v5による認証・認可
- Data Access Layer（DAL）パターン
- API呼び出し時のCSRFトークン検証
- パスワードのbcryptハッシュ化（ソルトラウンド10）
- Rate Limiting（APIレベル）
- トランザクション処理（アカウント削除）
- 入力値サニタイズ

## パフォーマンス考慮事項

### 現在の実装
- モックAPIのdelay:
  - getProfile: 300ms
  - updateProfile: 500ms
  - changePassword: 500ms
  - getSettings: 300ms
  - updateNotificationSettings: 300ms
  - deleteAccount: 1000ms
- React Hooks（useState、useEffect）によるデータ管理
- カスタムフック（useSettingsData）による状態管理

### 最適化予定
- React Queryによるキャッシング
- Server Componentsの活用（データ取得）
- フォームバリデーションのデバウンス
- Lighthouseスコア90+目標

## テスト実行ガイド

### 手動テスト手順
1. 開発サーバー起動: `npm run dev`
2. ブラウザで http://localhost:3247/settings にアクセス
3. 本仕様書のテスト項目を順次実行
4. 結果を「実施日」「結果」列に記録

### 自動テスト準備（Phase 5）
- Playwright / CypressによるE2Eテスト
- テストコード配置: `tests/e2e/settings.spec.ts`
- CI/CD統合（GitHub Actions）

## 備考

- 本仕様書はモック実装段階での作成
- API実装後、エンドポイントを実際のものに更新
- 認証実装後、テスト手順に認証フローを追加
- 新機能追加時は本仕様書も更新
- テスト実施後、不具合や改善点を「備考」欄に記録
- アカウント削除は複合API処理（UAS-001）で、関連する全データを一括削除する重要な機能

## 複合API処理詳細

### UAS-001: アカウント削除処理

**バックエンド内部処理フロー:**

1. **認証確認**
   - リクエストトークンからuserIdを取得
   - リクエストボディのuserIdと一致するか確認

2. **関連データ削除（トランザクション内）**
   ```sql
   DELETE FROM Goal WHERE userId = :userId
   DELETE FROM Task WHERE userId = :userId
   DELETE FROM Log WHERE userId = :userId
   DELETE FROM Reflection WHERE userId = :userId
   DELETE FROM AIAnalysisReport WHERE userId = :userId
   DELETE FROM ActionPlan WHERE userId = :userId
   DELETE FROM ChatMessage WHERE userId = :userId
   DELETE FROM Notification WHERE userId = :userId
   DELETE FROM UserSettings WHERE userId = :userId
   DELETE FROM Session WHERE userId = :userId
   DELETE FROM PasswordResetToken WHERE userId = :userId
   DELETE FROM User WHERE id = :userId
   ```

3. **セッション無効化**
   - すべてのSessionレコードを削除
   - JWTトークンをブラックリスト追加（Redis利用時）

4. **応答準備**
   - 処理完了通知
   - フロントエンドでログアウト処理

**外部サービス依存:**
- Supabase（データベース）
- Redis（オプション、セッション管理）

**セキュリティ要件:**
- CSRF保護必須
- 本人確認（currentPasswordの入力を求める実装も検討）
- トランザクション処理（削除失敗時は全ロールバック）
- 削除前にバックアップ作成（オプション）

---

**次のアクション**:
1. 高優先度テストの実施（E2E-SET-001から順次）
2. 問題発見時は Issues登録
3. SCOPE_PROGRESS.mdのE2Eテスト進捗表を更新
4. 全テスト完了後、カバレッジレポート作成
5. 本番API実装時にテスト項目を再確認・更新
